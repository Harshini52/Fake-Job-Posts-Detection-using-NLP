<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | JobGuard Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      :root {
        --primary: #3a56d4;
        --primary-light: #667eea;
        --primary-dark: #2d46b9;
        --secondary: #f72585;
        --accent: #4cc9f0;
        --warning: #f8961e;
        --danger: #f94144;
        --success: #43aa8b;
        --dark: #1e293b;
        --darker: #0f172a;
        --light: #f8fafc;
        --gray: #64748b;
        --gray-light: #e2e8f0;
        
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-shadow: rgba(58, 86, 212, 0.1);
        --gradient-primary: linear-gradient(135deg, #3a56d4 0%, #667eea 100%);
        --gradient-secondary: linear-gradient(135deg, #f72585 0%, #ff5d9e 100%);
        --gradient-accent: linear-gradient(135deg, #4cc9f0 0%, #72efdd 100%);
        --gradient-warning: linear-gradient(135deg, #f8961e 0%, #f9c74f 100%);
        --gradient-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      }

      body {
        background: var(--gradient-bg);
        color: var(--dark);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Navigation */
      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 30px;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
      }

      .brand-logo {
        width: 50px;
        height: 50px;
        background: var(--gradient-primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 5px 15px rgba(58, 86, 212, 0.3);
      }

      .brand-text {
        font-family: "Montserrat", sans-serif;
        font-size: 1.8rem;
        font-weight: 900;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 5px 15px var(--card-shadow);
      }

      .nav-buttons {
        display: flex;
        gap: 10px;
      }

      .nav-btn {
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .nav-btn-primary {
        background: var(--gradient-primary);
        color: white;
      }

      .nav-btn-secondary {
        background: var(--card-bg);
        color: var(--primary);
        border: 2px solid var(--primary-light);
      }

      .nav-btn-logout {
        background: rgba(249, 65, 68, 0.1);
        color: var(--danger);
      }

      /* Admin Header */
      .admin-header {
        margin: 30px 0;
      }

      .header-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(58, 86, 212, 0.1);
        color: var(--primary);
        padding: 6px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 15px;
      }

      .admin-title {
        font-family: "Montserrat", sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      /* Stats Grid */
      .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .admin-stat-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 25px var(--card-shadow);
        border-left: 5px solid var(--primary);
        transition: all 0.3s ease;
      }

      .admin-stat-card:hover {
        transform: translateY(-5px);
      }

      .admin-stat-card:nth-child(2) { border-left-color: var(--secondary); }
      .admin-stat-card:nth-child(3) { border-left-color: var(--accent); }
      .admin-stat-card:nth-child(4) { border-left-color: var(--warning); }
      .admin-stat-card:nth-child(5) { border-left-color: var(--success); }
      .admin-stat-card:nth-child(6) { border-left-color: var(--danger); }

      .admin-stat-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .admin-stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        background: var(--gradient-primary);
      }

      .admin-stat-card:nth-child(2) .admin-stat-icon { background: var(--gradient-secondary); }
      .admin-stat-card:nth-child(3) .admin-stat-icon { background: var(--gradient-accent); }
      .admin-stat-card:nth-child(4) .admin-stat-icon { background: var(--gradient-warning); }
      .admin-stat-card:nth-child(5) .admin-stat-icon { background: linear-gradient(135deg, var(--success) 0%, #4dffc3 100%); }
      .admin-stat-card:nth-child(6) .admin-stat-icon { background: linear-gradient(135deg, var(--danger) 0%, #ff7b7d 100%); }

      .admin-stat-info h3 {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 5px;
      }

      .admin-stat-info p {
        color: var(--gray);
        font-size: 0.9rem;
      }

      /* Export & Retrain Section */
      .admin-actions {
        display: flex;
        gap: 15px;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      .action-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 25px var(--card-shadow);
        flex: 1;
        min-width: 300px;
      }

      .action-card h3 {
        margin-bottom: 15px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .export-btn, .retrain-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .export-btn {
        background: rgba(67, 170, 139, 0.1);
        color: var(--success);
      }

      .export-btn:hover {
        background: var(--success);
        color: white;
      }

      .retrain-btn {
        background: rgba(58, 86, 212, 0.1);
        color: var(--primary);
      }

      .retrain-btn:hover {
        background: var(--primary);
        color: white;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 10px;
        margin: 30px 0;
        border-bottom: 2px solid rgba(58, 86, 212, 0.1);
        padding-bottom: 10px;
      }

      .tab-btn {
        padding: 10px 25px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: var(--gray);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      /* Tables */
      .table-container {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 25px var(--card-shadow);
        margin-bottom: 30px;
        overflow-x: auto;
      }

      .table-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .table-title h3 {
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        text-align: left;
        padding: 12px 15px;
        background: rgba(58, 86, 212, 0.05);
        color: var(--primary);
        font-weight: 600;
        border-bottom: 2px solid rgba(58, 86, 212, 0.1);
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(58, 86, 212, 0.05);
      }

      tr:hover {
        background: rgba(58, 86, 212, 0.02);
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .badge-success {
        background: rgba(67, 170, 139, 0.1);
        color: var(--success);
      }

      .badge-danger {
        background: rgba(249, 65, 68, 0.1);
        color: var(--danger);
      }

      .badge-warning {
        background: rgba(248, 150, 30, 0.1);
        color: var(--warning);
      }

      .badge-info {
        background: rgba(58, 86, 212, 0.1);
        color: var(--primary);
      }

      .action-cell {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
      }

      .btn-flag {
        background: rgba(248, 150, 30, 0.1);
        color: var(--warning);
      }

      .btn-flag:hover {
        background: var(--warning);
        color: white;
      }

      .btn-unflag {
        background: rgba(67, 170, 139, 0.1);
        color: var(--success);
      }

      .btn-unflag:hover {
        background: var(--success);
        color: white;
      }

      .btn-delete {
        background: rgba(249, 65, 68, 0.1);
        color: var(--danger);
      }

      .btn-delete:hover {
        background: var(--danger);
        color: white;
      }

      .btn-promote {
        background: rgba(76, 201, 240, 0.1);
        color: var(--accent);
      }

      .btn-promote:hover {
        background: var(--accent);
        color: white;
      }

      .btn-demote {
        background: rgba(247, 37, 133, 0.1);
        color: var(--secondary);
      }

      .btn-demote:hover {
        background: var(--secondary);
        color: white;
      }

      /* Loading */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(58, 86, 212, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: var(--primary);
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--gray);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
      }

      .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid rgba(58, 86, 212, 0.2);
        border-radius: 8px;
        font-size: 1rem;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
      }

      .btn-submit {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
      }

      /* Alert */
      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .alert-success {
        background: rgba(67, 170, 139, 0.1);
        border-left: 4px solid var(--success);
        color: var(--success);
      }

      .alert-error {
        background: rgba(249, 65, 68, 0.1);
        border-left: 4px solid var(--danger);
        color: var(--danger);
      }

      .alert-info {
        background: rgba(58, 86, 212, 0.1);
        border-left: 4px solid var(--primary);
        color: var(--primary);
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <a href="{{ url_for('index') }}" class="nav-brand">
                <div class="brand-logo">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <span class="brand-text">JobGuard</span>
            </a>

            <div class="nav-actions">
                <div class="user-profile">
                    <div class="user-avatar" style="background: var(--gradient-primary);">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <h4>{{ session.get('first_name', 'Admin') }}</h4>
                        <p>Administrator</p>
                    </div>
                </div>
                
                <div class="nav-buttons">
                    <a href="{{ url_for('index') }}" class="nav-btn nav-btn-secondary">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a href="{{ url_for('admin_dashboard') }}" class="nav-btn nav-btn-primary">
                        <i class="fas fa-chart-line"></i> Admin
                    </a>
                    <a href="{{ url_for('logout') }}" class="nav-btn nav-btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Admin Header -->
        <div class="admin-header">
            <div class="header-badge">
                <i class="fas fa-crown"></i>
                Administrator Control Panel
            </div>
            <h1 class="admin-title">Admin Dashboard</h1>
            <p>Manage users, flagged posts, and system analytics</p>
        </div>

        <!-- Stats Grid -->
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="totalUsers">{{ total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="totalAdmins">{{ total_admins }}</h3>
                        <p>Total Admins</p>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="totalPredictions">{{ total_predictions }}</h3>
                        <p>Total Predictions</p>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="flaggedPredictions">{{ flagged_predictions }}</h3>
                        <p>Flagged Posts</p>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="todayPredictions">{{ today_predictions }}</h3>
                        <p>Today's Predictions</p>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-content">
                    <div class="admin-stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="admin-stat-info">
                        <h3 id="fakeRate">{{ fake_rate }}%</h3>
                        <p>Fake Detection Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export & Retrain Actions -->
        <div class="admin-actions">
            <div class="action-card">
                <h3><i class="fas fa-download"></i> Export Data</h3>
                <div class="action-buttons">
                    <button class="export-btn" onclick="exportData('users')">
                        <i class="fas fa-users"></i> Export Users
                    </button>
                    <button class="export-btn" onclick="exportData('predictions')">
                        <i class="fas fa-database"></i> Export Predictions
                    </button>
                    <button class="export-btn" onclick="exportData('logs')">
                        <i class="fas fa-history"></i> Export Logs
                    </button>
                </div>
            </div>

            <div class="action-card">
                <h3><i class="fas fa-robot"></i> Model Management</h3>
                <div class="action-buttons">
                    <button class="retrain-btn" onclick="retrainModel()">
                        <i class="fas fa-sync-alt"></i> Retrain Model
                    </button>
                    <button class="export-btn" onclick="showModelLogs()">
                        <i class="fas fa-list"></i> View Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('flagged')">
                <i class="fas fa-flag"></i> Flagged Posts
            </button>
            <button class="tab-btn" onclick="showTab('logs')">
                <i class="fas fa-history"></i> Today's Logs
            </button>
            <button class="tab-btn" onclick="showTab('users')">
                <i class="fas fa-users"></i> User Management
            </button>
        </div>

        <!-- Flagged Posts Tab -->
        <div id="flagged-tab" class="tab-content">
            <div class="table-container">
                <div class="table-title">
                    <h3><i class="fas fa-flag"></i> Flagged Posts ({{ flagged_predictions }})</h3>
                </div>
                {% if flagged_posts %}
                <table>
                    <thead>
                        <tr>
                            <th>Scan ID</th>
                            <th>User</th>
                            <th>Result</th>
                            <th>Confidence</th>
                            <th>Flag Reason</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in flagged_posts %}
                        <tr>
                            <td>{{ post.scan_id }}</td>
                            <td>
                                <div>{{ post.user }}</div>
                                <small style="color: var(--gray);">{{ post.email }}</small>
                            </td>
                            <td>
                                <span class="badge {% if post.result == 'Fake Job' %}badge-danger{% else %}badge-success{% endif %}">
                                    {{ post.result }}
                                </span>
                            </td>
                            <td>{{ post.confidence }}%</td>
                            <td>{{ post.flag_reason }}</td>
                            <td>{{ post.created_date }} {{ post.created_time }}</td>
                            <td class="action-cell">
                                <button class="action-btn btn-unflag" onclick="unflagPost({{ post.id }})">
                                    <i class="fas fa-flag"></i> Unflag
                                </button>
                                <button class="action-btn btn-delete" onclick="deletePost({{ post.id }})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-flag" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>No Flagged Posts</h3>
                    <p>There are currently no flagged posts to review.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Today's Logs Tab -->
        <div id="logs-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <div class="table-title">
                    <h3><i class="fas fa-history"></i> Today's Prediction Logs ({{ today_predictions }})</h3>
                </div>
                {% if todays_logs %}
                <table>
                    <thead>
                        <tr>
                            <th>Scan ID</th>
                            <th>User</th>
                            <th>Method</th>
                            <th>Result</th>
                            <th>Confidence</th>
                            <th>Risk Score</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in todays_logs %}
                        <tr>
                            <td>{{ log.scan_id }}</td>
                            <td>
                                <div>{{ log.user }}</div>
                                <small style="color: var(--gray);">{{ log.email }}</small>
                            </td>
                            <td>{{ log.method }}</td>
                            <td>
                                <span class="badge {% if log.result == 'Fake Job' %}badge-danger{% else %}badge-success{% endif %}">
                                    {{ log.result }}
                                </span>
                            </td>
                            <td>{{ log.confidence }}%</td>
                            <td>{{ log.score }}</td>
                            <td>{{ log.created_time }}</td>
                            <td class="action-cell">
                                <button class="action-btn btn-flag" onclick="showFlagModal({{ log.id }})">
                                    <i class="fas fa-flag"></i> Flag
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>No Predictions Today</h3>
                    <p>No prediction logs found for today.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="users-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <div class="table-title">
                    <h3><i class="fas fa-users"></i> User Management ({{ total_users }})</h3>
                    <input type="text" class="form-control" placeholder="Search users..." style="width: 300px;" id="userSearch" oninput="searchUsers()">
                </div>
                {% if users %}
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Logins</th>
                            <th>Predictions</th>
                            <th>Joined</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr data-user-id="{{ user.id }}">
                            <td>
                                <div><strong>{{ user.first_name }} {{ user.last_name }}</strong></div>
                                <small style="color: var(--gray);">ID: {{ user.id }}</small>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                <span class="badge {% if user.is_admin == 1 %}badge-warning{% else %}badge-info{% endif %}">
                                    {% if user.is_admin == 1 %}Admin{% else %}User{% endif %}
                                </span>
                            </td>
                            <td>{{ user.login_count }}</td>
                            <td>{{ user.prediction_count }}</td>
                            <td>{{ user.created_date }}</td>
                            <td>
                                {% if user.last_login_date != 'Never' %}
                                {{ user.last_login_date }}<br>
                                <small>{{ user.last_login_time }}</small>
                                {% else %}
                                Never
                                {% endif %}
                            </td>
                            <td class="action-cell">
                                {% if user.is_admin == 0 %}
                                <button class="action-btn btn-promote" onclick="promoteUser({{ user.id }}, '{{ user.first_name }}')">
                                    <i class="fas fa-user-shield"></i> Promote
                                </button>
                                {% else %}
                                <button class="action-btn btn-demote" onclick="demoteUser({{ user.id }}, '{{ user.first_name }}')"
                                        {% if user.id == session.get('user_id') %}disabled title="You cannot demote yourself"{% endif %}>
                                    <i class="fas fa-user-minus"></i> Demote
                                </button>
                                {% endif %}
                                <button class="action-btn btn-delete" onclick="deleteUser({{ user.id }}, '{{ user.first_name }}')"
                                        {% if user.id == session.get('user_id') %}disabled title="You cannot delete yourself"{% endif %}>
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-users-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>No Users Found</h3>
                    <p>There are currently no users in the system.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Model Logs -->
        <div class="table-container">
            <div class="table-title">
                <h3><i class="fas fa-list"></i> Model Training Logs</h3>
            </div>
            {% if model_logs %}
            <table>
                <thead>
                    <tr>
                        <th>Admin</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in model_logs %}
                    <tr>
                        <td>{{ log.admin }}</td>
                        <td>
                            <span class="badge badge-info">{{ log.action }}</span>
                        </td>
                        <td>{{ log.details }}</td>
                        <td>{{ log.created_date }} {{ log.created_time }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 20px; color: var(--gray);">
                <p>No model training logs found.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Flag Modal -->
    <div id="flagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flag"></i> Flag Post</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form id="flagForm">
                <div class="form-group">
                    <label for="flagReason">Flag Reason</label>
                    <select class="form-control" id="flagReason" required>
                        <option value="">Select a reason</option>
                        <option value="False positive">False positive</option>
                        <option value="Inappropriate content">Inappropriate content</option>
                        <option value="Suspicious activity">Suspicious activity</option>
                        <option value="System error">System error</option>
                        <option value="Manual review needed">Manual review needed</option>
                        <option value="Other">Other</                    </select>
                </div>
                <div class="form-group" id="customReason" style="display: none;">
                    <label for="customFlagReason">Custom Reason</label>
                    <input type="text" class="form-control" id="customFlagReason" placeholder="Enter custom reason">
                </div>
                <button type="submit" class="btn-submit">
                    <i class="fas fa-flag"></i> Flag Post
                </button>
            </form>
        </div>
    </div>

    <script>
        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Modal management
        let currentPredictionId = null;

        function showFlagModal(predictionId) {
            currentPredictionId = predictionId;
            document.getElementById('flagModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('flagModal').style.display = 'none';
            document.getElementById('flagReason').value = '';
            document.getElementById('customReason').style.display = 'none';
            currentPredictionId = null;
        }

        // Handle flag reason selection
        document.getElementById('flagReason').addEventListener('change', function() {
            const customReasonDiv = document.getElementById('customReason');
            if (this.value === 'Other') {
                customReasonDiv.style.display = 'block';
            } else {
                customReasonDiv.style.display = 'none';
            }
        });

        // Handle flag form submission
        document.getElementById('flagForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const reason = document.getElementById('flagReason').value;
            let flagReason = reason;
            
            if (reason === 'Other') {
                flagReason = document.getElementById('customFlagReason').value.trim();
                if (!flagReason) {
                    showNotification('Please enter a custom reason', 'error');
                    return;
                }
            }
            
            if (!currentPredictionId) {
                showNotification('No post selected', 'error');
                return;
            }
            
            flagPost(currentPredictionId, flagReason);
        });

        // Export data
        function exportData(dataType) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> Exporting...';
            button.disabled = true;
            
            fetch(`/admin/export/${dataType}`)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Export failed');
                })
                .then(blob => {
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `jobguard_${dataType}_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification(`${dataType.charAt(0).toUpperCase() + dataType.slice(1)} exported successfully`, 'success');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showNotification('Error exporting data', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
        }

        // Retrain model
        function retrainModel() {
            if (!confirm('Are you sure you want to retrain the model?\n\nThis process may take a few minutes.')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading"></div> Retraining...';
            button.disabled = true;
            
            fetch('/admin/retrain-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Refresh page after 2 seconds to show updated logs
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Retrain error:', error);
                showNotification('Error retraining model', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Flag post
        function flagPost(predictionId, reason) {
            fetch(`/admin/flag/${predictionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeModal();
                    // Refresh flagged posts tab
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Flag error:', error);
                showNotification('Error flagging post', 'error');
            });
        }

        // Unflag post
        function unflagPost(predictionId) {
            if (!confirm('Are you sure you want to unflag this post?')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading"></div>';
            button.disabled = true;
            
            fetch(`/admin/unflag/${predictionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Remove row from table
                    const row = button.closest('tr');
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.remove();
                        // Update flagged count
                        const flaggedCount = document.getElementById('flaggedPredictions');
                        flaggedCount.textContent = parseInt(flaggedCount.textContent) - 1;
                    }, 300);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Unflag error:', error);
                showNotification('Error unflagging post', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Delete post
        function deletePost(predictionId) {
            if (!confirm('⚠️ WARNING: Are you sure you want to delete this post?\n\nThis action cannot be undone.')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading"></div>';
            button.disabled = true;
            
            fetch(`/admin/delete-post/${predictionId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Remove row from table
                    const row = button.closest('tr');
                    row.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        row.remove();
                        // Update counts
                        const flaggedCount = document.getElementById('flaggedPredictions');
                        const totalCount = document.getElementById('totalPredictions');
                        if (flaggedCount) flaggedCount.textContent = parseInt(flaggedCount.textContent) - 1;
                        if (totalCount) totalCount.textContent = parseInt(totalCount.textContent) - 1;
                    }, 300);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showNotification('Error deleting post', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Promote user
        function promoteUser(userId, userName) {
            if (confirm(`Are you sure you want to promote ${userName} to Administrator?\n\nThey will gain admin privileges.`)) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loading"></div>';
                button.disabled = true;
                
                fetch(`/admin/promote/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        
                        // Update UI
                        const row = button.closest('tr');
                        const roleCell = row.cells[2];
                        const actionCell = row.cells[7];
                        
                        // Update role badge
                        roleCell.innerHTML = '<span class="badge badge-warning">Admin</span>';
                        
                        // Update action buttons
                        actionCell.innerHTML = `
                            <button class="action-btn btn-demote" onclick="demoteUser(${userId}, '${userName}')">
                                <i class="fas fa-user-minus"></i> Demote
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser(${userId}, '${userName}')" disabled>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                        
                        // Update admin count
                        const adminCount = document.getElementById('totalAdmins');
                        adminCount.textContent = parseInt(adminCount.textContent) + 1;
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Promote error:', error);
                    showNotification('Error promoting user', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }

        // Demote user
        function demoteUser(userId, userName) {
            if (userId === {{ session.get('user_id', 0) }}) {
                showNotification('You cannot demote yourself', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to demote ${userName} from Administrator?\n\nThey will lose admin privileges.`)) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loading"></div>';
                button.disabled = true;
                
                fetch(`/admin/demote/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        
                        // Update UI
                        const row = button.closest('tr');
                        const roleCell = row.cells[2];
                        const actionCell = row.cells[7];
                        
                        // Update role badge
                        roleCell.innerHTML = '<span class="badge badge-info">User</span>';
                        
                        // Update action buttons
                        actionCell.innerHTML = `
                            <button class="action-btn btn-promote" onclick="promoteUser(${userId}, '${userName}')">
                                <i class="fas fa-user-shield"></i> Promote
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser(${userId}, '${userName}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                        
                        // Update admin count
                        const adminCount = document.getElementById('totalAdmins');
                        adminCount.textContent = parseInt(adminCount.textContent) - 1;
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Demote error:', error);
                    showNotification('Error demoting user', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }

        // Delete user
        function deleteUser(userId, userName) {
            if (userId === {{ session.get('user_id', 0) }}) {
                showNotification('You cannot delete yourself', 'error');
                return;
            }
            
            if (confirm(`⚠️ WARNING: Are you sure you want to delete user ${userName}?\n\nThis will permanently delete all their data.`)) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loading"></div>';
                button.disabled = true;
                
                fetch(`/admin/delete/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        
                        // Remove row from table
                        const row = button.closest('tr');
                        row.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            row.remove();
                            
                            // Update user count
                            const userCount = document.getElementById('totalUsers');
                            userCount.textContent = parseInt(userCount.textContent) - 1;
                            
                            // Update admin count if needed
                            const wasAdmin = row.querySelector('.badge-warning');
                            if (wasAdmin) {
                                const adminCount = document.getElementById('totalAdmins');
                                adminCount.textContent = parseInt(adminCount.textContent) - 1;
                            }
                        }, 300);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    showNotification('Error deleting user', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }

        // Search users
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tbody tr');
            
            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const email = row.cells[1].textContent.toLowerCase();
                
                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Show model logs
        function showModelLogs() {
            // Scroll to model logs section
            document.querySelector('.table-container:last-child').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.querySelector('.container').prepend(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(-100px); }
            }
            
            .tab-content {
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('flagModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Initialize search on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('flagReason').addEventListener('change', function() {
                const customReasonDiv = document.getElementById('customReason');
                if (this.value === 'Other') {
                    customReasonDiv.style.display = 'block';
                } else {
                    customReasonDiv.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>